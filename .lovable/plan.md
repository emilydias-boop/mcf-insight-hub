
# Plano: Relat√≥rio de Qualifica√ß√£o R2 (Consolidated)

## Objetivo

Criar um relat√≥rio consolidado das respostas de qualifica√ß√£o dos leads R2 para an√°lise gerencial. O relat√≥rio permitir√°:

1. **Para a equipe R2** (aba ao lado de No-Shows): Visualiza√ß√£o r√°pida das qualifica√ß√µes
2. **Para Diretoria/CEOs** (em Relat√≥rios): An√°lise consolidada com filtros e exporta√ß√£o Excel

---

## Vis√£o Geral da Solu√ß√£o

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AGENDA R2 - Nova Aba                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Tabs: Lista | Calend√°rio | Por S√≥cio | Pendentes | No-Shows | RELAT√ìRIO |
‚îÇ                                                                ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ ‚îÇ   Por Estado    ‚îÇ ‚îÇ   Por Renda     ‚îÇ ‚îÇ  Por Profiss√£o  ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  ‚îÇ SP: 45    ‚îÇ  ‚îÇ ‚îÇ  ‚îÇ10k-20k:32 ‚îÇ  ‚îÇ ‚îÇ  ‚îÇEmpres√°rio ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  ‚îÇ RJ: 28    ‚îÇ  ‚îÇ ‚îÇ  ‚îÇ20k-30k:18 ‚îÇ  ‚îÇ ‚îÇ  ‚îÇ   :28     ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  ‚îÇ MG: 15    ‚îÇ  ‚îÇ ‚îÇ  ‚îÇ +30k: 12  ‚îÇ  ‚îÇ ‚îÇ  ‚îÇEngenheiro ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ  ‚îÇ   :22     ‚îÇ  ‚îÇ   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ                  Tabela Detalhada                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Lead | Estado | Renda | Profiss√£o | Status | Closer | ... ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ                 [üìä Exportar Excel]                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Componentes a Criar

### 1. Hook: `useR2QualificationReport`

Buscar dados de qualifica√ß√£o consolidados das reuni√µes R2.

**Arquivo:** `src/hooks/useR2QualificationReport.ts`

**Dados retornados:**
```typescript
interface R2QualificationReportRow {
  id: string;
  leadName: string;
  phone: string | null;
  email: string | null;
  scheduledAt: string;
  status: string;
  closerName: string;
  sdrName: string | null;
  salesChannel: 'A010' | 'LIVE';
  // Campos de qualifica√ß√£o
  estado: string | null;
  profissao: string | null;
  renda: string | null;
  idade: string | null;
  jaConstroi: string | null;
  terreno: string | null;
  imovel: string | null;
  tempoMcf: string | null;
  temSocio: boolean | null;
  nomeSocio: string | null;
}
```

**Query:** Buscar `meeting_slot_attendees` com JOIN em `crm_deals.custom_fields` para extrair os campos de qualifica√ß√£o.

### 2. Componente: `R2QualificationReportPanel`

Painel com filtros, gr√°ficos de distribui√ß√£o e tabela de dados.

**Arquivo:** `src/components/crm/R2QualificationReportPanel.tsx`

**Funcionalidades:**
- Filtros por per√≠odo, closer, status
- Gr√°ficos de distribui√ß√£o (por Estado, Renda, Profiss√£o, Terreno, J√° Constr√≥i)
- Tabela detalhada com todas as colunas
- Bot√£o "Exportar Excel" com formato igual √† planilha manual

### 3. Integra√ß√£o na Agenda R2

**Arquivo:** `src/pages/crm/AgendaR2.tsx`

Adicionar nova aba "Relat√≥rio" ao lado de "No-Shows".

### 4. P√°gina para Relat√≥rios Gerais (Opcional)

**Arquivo:** `src/pages/relatorios/QualificacaoR2.tsx`

P√°gina acess√≠vel via menu Relat√≥rios para Chairman/CEOs com vis√£o consolidada completa.

---

## Detalhes T√©cnicos

### Hook `useR2QualificationReport.ts`

```typescript
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { startOfDay, endOfDay, format } from 'date-fns';

interface QualificationFilters {
  startDate: Date;
  endDate: Date;
  closerId?: string;
  status?: string;
}

export function useR2QualificationReport(filters: QualificationFilters) {
  return useQuery({
    queryKey: ['r2-qualification-report', filters],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('meeting_slots')
        .select(`
          id,
          scheduled_at,
          status,
          closer:closers!meeting_slots_closer_id_fkey(id, name),
          attendees:meeting_slot_attendees(
            id,
            attendee_name,
            attendee_phone,
            status,
            deal:crm_deals(
              id,
              name,
              owner_id,
              custom_fields,
              contact:crm_contacts(name, email, phone)
            )
          )
        `)
        .eq('meeting_type', 'r2')
        .gte('scheduled_at', startOfDay(filters.startDate).toISOString())
        .lte('scheduled_at', endOfDay(filters.endDate).toISOString());
      
      if (error) throw error;
      
      // Transform and flatten data
      return data.flatMap(meeting => 
        meeting.attendees.map(att => ({
          id: att.id,
          leadName: att.attendee_name || att.deal?.contact?.name,
          phone: att.attendee_phone || att.deal?.contact?.phone,
          email: att.deal?.contact?.email,
          scheduledAt: meeting.scheduled_at,
          status: att.status,
          closerName: meeting.closer?.name,
          // Qualification fields from custom_fields
          estado: att.deal?.custom_fields?.estado,
          profissao: att.deal?.custom_fields?.profissao,
          renda: att.deal?.custom_fields?.renda,
          idade: att.deal?.custom_fields?.idade,
          jaConstroi: att.deal?.custom_fields?.ja_constroi,
          terreno: att.deal?.custom_fields?.terreno,
          imovel: att.deal?.custom_fields?.possui_imovel,
          tempoMcf: att.deal?.custom_fields?.tempo_conhece_mcf,
          temSocio: att.deal?.custom_fields?.tem_socio,
          nomeSocio: att.deal?.custom_fields?.nome_socio,
        }))
      );
    }
  });
}
```

### Componente `R2QualificationReportPanel.tsx`

**Estrutura:**

```tsx
export function R2QualificationReportPanel() {
  // Filtros de per√≠odo e closer
  const [dateRange, setDateRange] = useState<DateRange>();
  const [closerFilter, setCloserFilter] = useState('all');
  
  const { data = [], isLoading } = useR2QualificationReport({
    startDate: dateRange?.from || startOfMonth(new Date()),
    endDate: dateRange?.to || endOfMonth(new Date()),
    closerId: closerFilter !== 'all' ? closerFilter : undefined,
  });
  
  // Agrega√ß√µes para gr√°ficos
  const estadoStats = useMemo(() => 
    groupBy(data, 'estado'), [data]
  );
  const rendaStats = useMemo(() => 
    groupBy(data, 'renda'), [data]
  );
  
  // Exportar Excel
  const handleExport = () => {
    const ws = XLSX.utils.json_to_sheet(data.map(row => ({
      'Nome': row.leadName,
      'Telefone': row.phone,
      'Email': row.email,
      'Data Reuni√£o': format(new Date(row.scheduledAt), 'dd/MM/yyyy'),
      'Hor√°rio': format(new Date(row.scheduledAt), 'HH:mm'),
      'Status': row.status,
      'S√≥cio R2': row.closerName,
      'Estado': row.estado,
      'Profiss√£o': row.profissao,
      'Renda': row.renda,
      'Idade': row.idade,
      'J√° Constr√≥i': row.jaConstroi,
      'Tem Terreno': row.terreno,
      'Tem Im√≥vel': row.imovel,
      'Conhece MCF': row.tempoMcf,
      'Tem S√≥cio': row.temSocio ? 'Sim' : 'N√£o',
      'Nome S√≥cio': row.nomeSocio,
    })));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Qualifica√ß√£o R2');
    XLSX.writeFile(wb, `qualificacao_r2_${format(new Date(), 'yyyy-MM-dd')}.xlsx`);
  };
  
  return (
    <div className="space-y-6">
      {/* Filtros */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex gap-4">
            <DatePickerCustom mode="range" ... />
            <Select value={closerFilter} ... />
            <Button onClick={handleExport}>
              <FileSpreadsheet className="h-4 w-4 mr-2" />
              Exportar Excel
            </Button>
          </div>
        </CardContent>
      </Card>
      
      {/* Gr√°ficos de Distribui√ß√£o */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardHeader><CardTitle>Por Estado</CardTitle></CardHeader>
          <CardContent>
            <PieChart ... />
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader><CardTitle>Por Renda</CardTitle></CardHeader>
          <CardContent>
            <BarChart ... />
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader><CardTitle>Por Profiss√£o</CardTitle></CardHeader>
          <CardContent>
            <BarChart ... />
          </CardContent>
        </Card>
      </div>
      
      {/* Tabela Detalhada */}
      <Card>
        <Table>
          <TableHeader>...</TableHeader>
          <TableBody>
            {data.map(row => <TableRow key={row.id}>...</TableRow>)}
          </TableBody>
        </Table>
      </Card>
    </div>
  );
}
```

### Integra√ß√£o na AgendaR2.tsx

Adicionar nova TabTrigger e TabsContent:

```tsx
// No TabsList (ap√≥s No-Shows)
<TabsTrigger value="report" className="gap-2">
  <FileText className="h-4 w-4" />
  Relat√≥rio
</TabsTrigger>

// Novo TabsContent
<TabsContent value="report" className="mt-0">
  <R2QualificationReportPanel />
</TabsContent>
```

---

## Colunas do Relat√≥rio (baseado na planilha)

| Coluna | Campo | Origem |
|--------|-------|--------|
| Nome | `attendee_name` | meeting_slot_attendees |
| Email | `email` | crm_contacts |
| Telefone | `attendee_phone` | meeting_slot_attendees |
| Respons√°vel (SDR) | `owner_id` | crm_deals |
| S√≥cio R2 | `closer.name` | closers |
| Status Agendamento | `status` | meeting_slot_attendees |
| Status Yanca | customizado | custom_fields |
| Vendas | vinculado | hubla_transactions |
| Idade | `custom_fields.idade` | crm_deals |
| Renda | `custom_fields.renda` | crm_deals |
| Estado | `custom_fields.estado` | crm_deals |
| Profiss√£o | `custom_fields.profissao` | crm_deals |
| Constr√≥i | `custom_fields.ja_constroi` | crm_deals |
| Tem S√≥cio | `custom_fields.tem_socio` | crm_deals |
| Im√≥vel Pr√≥prio | `custom_fields.possui_imovel` | crm_deals |
| Tem Terreno | `custom_fields.terreno` | crm_deals |
| Conhece MCF | `custom_fields.tempo_conhece_mcf` | crm_deals |

---

## Arquivos a Criar/Modificar

| Arquivo | A√ß√£o |
|---------|------|
| `src/hooks/useR2QualificationReport.ts` | **Criar** - Hook para buscar dados consolidados |
| `src/components/crm/R2QualificationReportPanel.tsx` | **Criar** - Painel com gr√°ficos e tabela |
| `src/pages/crm/AgendaR2.tsx` | **Modificar** - Adicionar aba "Relat√≥rio" |
| `src/pages/relatorios/QualificacaoR2.tsx` | **Criar** (opcional) - P√°gina para menu Relat√≥rios |

---

## Acesso por Roles

| Localiza√ß√£o | Roles com Acesso |
|-------------|------------------|
| Agenda R2 > Aba Relat√≥rio | `admin`, `manager`, `coordenador`, `closer` (s√≥cio R2) |
| Relat√≥rios > Qualifica√ß√£o R2 | `admin`, `manager` (Chairman, CEOs) |

---

## Resultado Esperado

1. **Nova aba "Relat√≥rio"** na Agenda R2 ao lado de "No-Shows"
2. **Gr√°ficos de distribui√ß√£o** mostrando estados mais frequentes, faixas de renda, profiss√µes
3. **Tabela completa** com todos os dados de qualifica√ß√£o
4. **Exporta√ß√£o Excel** no mesmo formato da planilha manual
5. **Filtros** por per√≠odo, closer, status para an√°lise segmentada

